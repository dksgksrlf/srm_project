<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.oti.team2.srinformation.dao.ISrinformationDao"> <!-- 식별 이름은 전체 이름을 넣어야됨 -->

	<!-- 모든 진척 목록(조회) -->
	<select id="selectInfoAll" parameterType="string" resultType="srinformationlist">
		SELECT
			SI.DMND_NO AS dmndNo,
			SI.SR_NO AS srNo,
			S1.SYS_NM AS sysNm,
			T.TASK_SE_NM AS taskSeNm,
			SD.TTL AS ttl,
			M.FLNM AS flnm,
			SI.BGNG_YMD AS bgngYmd,
			SI.END_YMD AS endYmd,
			S2.STTS_NM AS sttsNm
		FROM 
			SR_INFORMATION SI, SR_DEMAND SD, TASK T, MEMBERS M, SYSTEMS S1, STATUS S2
		WHERE 
			SD.DMND_NO = SI.DMND_NO
		AND
			SD.TASK_SE_CD = T.TASK_SE_CD
		AND
			SD.CUST_ID = M.MEMBER_ID
		AND
			S1.SYS_CD = SD.SYS_CD
		AND
			S2.STTS_CD = SD.STTS_CD
		ORDER BY 
			SI.DMND_NO ASC
	</select>
	
	<!-- 모든 개발부서 목록(조회) -->
	<select id="selectDept" parameterType="string" resultType="dept">
		SELECT
			DEPT_CD AS deptCd,
			DEPT_NM AS deptNm
		FROM
			DEPARTMENTS
	</select>
	
	<!-- 부서 변경시 해당 담당자 출력 -->
	<select id="selectFlnmByDeptCd" parameterType="string" resultType="manager">
		SELECT
			FLNM AS flnm,
			MEMBER_ID AS memberId
		FROM
			DEPARTMENTS D, MEMBERS M
		WHERE
			D.MNGR_ID = M.MEMBER_ID
		AND
			D.DEPT_CD = #{deptCd}
	</select>
	
	<!-- 계획정보 -->
	<select id="selectPlanByDmndNo" parameterType="string" resultType="srplanInfomation">
		SELECT
			SI.DMND_NO AS dmndNo,
			M.MEMBER_ID AS memberId,
			D.DEPT_NM AS deptNm,
			M.FLNM AS flnm,
			to_char(SI.BGNG_YMD, 'YYYY-MM-DD') AS bgngYmd,
			to_char(SI.END_YMD, 'YYYY-MM-DD') AS endYmd,
			SI.RVW_CN AS rvwCn,
			SI.DEPT_CD AS deptCd
		FROM
			SR_INFORMATION SI, MEMBERS M, DEPARTMENTS D
		WHERE
			SI.DMND_NO = #{dmndNo}
		AND
			SI.DEPT_CD = D.DEPT_CD
		AND
			SI.PIC_ID = M.MEMBER_ID
	</select>
	
	<!-- 계획정보 변경 -->
	<update id="updateSrInfo" parameterType="srplanInfomation">
		UPDATE 
			SR_INFORMATION
		SET
			BGNG_YMD = #{srplanInfomation.bgngYmd},
			END_YMD = #{srplanInfomation.endYmd},
			DEPT_CD = #{srplanInfomation.deptCd},
			PIC_ID = #{srplanInfomation.memberId},
			RVW_CN = #{srplanInfomation.rvwCn}
		WHERE
			DMND_NO = #{srplanInfomation.dmndNo}
		
	</update>
	
	<!-- WOR-2023 으로 시작하는 데이터의 수를 가져온다.  -->
	<select id="countBySrNo" parameterType="string" resultType="int">
		SELECT count(SR_NO)
		FROM SR_INFORMATION
		WHERE SR_NO LIKE #{srCode}
	</select>
	
	<!--승인된 요청건을 srInformation 데이터 insert -->
	<insert id="insertSrInformatioin" parameterType="srInformationRequestDto">
		INSERT INTO SR_INFORMATION (
			SR_NO, DMND_NO, DEPT_CD, PIC_ID, RNK, BGNG_YMD, END_YMD)
		VALUES (#{srNo}, #{dmndNo}, #{deptCd}, #{picId}, #{rnk}, #{bgngYmd}, #{endYmd})	
	</insert>
</mapper>